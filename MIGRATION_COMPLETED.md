# ğŸ‰ MFBPé¡¹ç›®æ•°æ®ç»“æ„è¿ç§»å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ è¿ç§»æ¦‚è¿°
**é¡¹ç›®**: MFBP (åŸºäºPyTorch Lightningçš„ç©ºé—´è½¬å½•ç»„å­¦æ¨¡å‹)  
**è¿ç§»ç±»å‹**: ä»åŸå§‹HESTæ ¼å¼å®Œå…¨è¿ç§»åˆ°æ–°çš„hest1k_datasetsæ ¼å¼  
**å®Œæˆæ—¶é—´**: 2024å¹´  
**çŠ¶æ€**: âœ… **å®Œå…¨æˆåŠŸ**

---

## ğŸ”„ æ ¸å¿ƒå˜æ›´æ€»ç»“

### 1. **æ•°æ®ç»“æ„å˜æ›´** âœ…
- **åŸå§‹æ ¼å¼**: `/data/ouyangjiarui/hest/processhest/`
- **æ–°æ ¼å¼**: `/data/ouyangjiarui/stem/hest1k_datasets/`
- **æ–‡ä»¶æ ¼å¼å˜æ›´**:
  - åµŒå…¥æ–‡ä»¶: `.h5` (HDF5) â†’ `.pt` (PyTorch)
  - åŸºå› åˆ—è¡¨: `.json` â†’ `.txt`
  - æ•°æ®åˆ’åˆ†: `.csv` â†’ å‘½ä»¤è¡Œå‚æ•°

### 2. **æ¨¡å‹ç®€åŒ–** âœ…
- **ä»**: åŒä»»åŠ¡å­¦ä¹  (åŸºå› è¡¨è¾¾ + å¯†åº¦é¢„æµ‹)
- **åˆ°**: å•ä»»åŠ¡å­¦ä¹  (ä»…åŸºå› è¡¨è¾¾é¢„æµ‹)
- **ç§»é™¤**: æ‰€æœ‰å¯†åº¦é¢„æµ‹ç›¸å…³ä»£ç  (~300è¡Œ)

### 3. **å‚æ•°ç³»ç»Ÿå˜æ›´** âœ…
- **ä»**: Fold-basedåˆ’åˆ† (`--fold 0`)
- **åˆ°**: Slide-basedåˆ’åˆ† (`--slide_val "id1,id2"`)
- **æ–°å¢**: 6ä¸ªæ–°å‘½ä»¤è¡Œå‚æ•°
- **ç§»é™¤**: 2ä¸ªæ—§å‚æ•°

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä»£ç æ–‡ä»¶
1. **`src/main.py`** - æ›´æ–°å‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®ä¼ é€’
2. **`src/dataset/hest_dataset.py`** - å®Œå…¨é‡æ„STDatasetç±»ï¼Œç§»é™¤BKDDataset
3. **`src/dataset/data_interface.py`** - ç®€åŒ–DataInterfaceç±»
4. **`src/dataset/__init__.py`** - æ›´æ–°æ¨¡å—å¯¼å…¥
5. **`src/model/model_interface.py`** - ç®€åŒ–æŸå¤±è®¡ç®—ï¼Œç§»é™¤å¯†åº¦é¢„æµ‹
6. **`src/model/MFBP/MFBP.py`** - é‡å†™MFBPæ¨¡å‹ï¼Œä½¿ç”¨ç®€åŒ–æ¶æ„

### é…ç½®æ–‡ä»¶
7. **`config/hest/base_config.yaml`** - æ·»åŠ MODELé…ç½®ï¼Œç§»é™¤å¯†åº¦ç›¸å…³é…ç½®

### æµ‹è¯•å’Œæ–‡æ¡£
8. **`test_migration.py`** - è¿ç§»éªŒè¯æµ‹è¯•è„šæœ¬
9. **`MIGRATION_COMPLETED.md`** - æœ¬å®ŒæˆæŠ¥å‘Š

---

## ğŸ†• æ–°å‘½ä»¤è¡Œæ¥å£

### æ ‡å‡†è®­ç»ƒå‘½ä»¤
```bash
python src/main.py \
    --config config/hest/base_config.yaml \
    --expr_name PRAD \
    --data_path /data/ouyangjiarui/stem/hest1k_datasets/PRAD/ \
    --slide_val "SPA154,SPA153" \
    --slide_test "SPA152,SPA151" \
    --encoder_name uni \
    --use_augmented \
    --mode train
```

### å‚æ•°è¯´æ˜
| å‚æ•° | ç±»å‹ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `--expr_name` | str | âœ… | æ•°æ®é›†åç§° | `PRAD`, `her2st`, `kidney` |
| `--data_path` | str | âœ… | æ•°æ®é›†æ ¹ç›®å½• | `/path/to/hest1k_datasets/PRAD/` |
| `--slide_val` | str | âŒ | éªŒè¯é›†slides | `"SPA154,SPA153"` |
| `--slide_test` | str | âŒ | æµ‹è¯•é›†slides | `"SPA152,SPA151"` |
| `--encoder_name` | str | âŒ | ç¼–ç å™¨ç±»å‹ | `uni` (é»˜è®¤), `conch` |
| `--use_augmented` | flag | âŒ | ä½¿ç”¨å¢å¼ºåµŒå…¥ | æ·»åŠ æ­¤å‚æ•°å¯ç”¨ |

---

## ğŸ—‚ï¸ æ–°æ•°æ®æ ¼å¼è¦æ±‚

### ç›®å½•ç»“æ„
```
/data/ouyangjiarui/stem/hest1k_datasets/PRAD/
â”œâ”€â”€ st/                              # STæ•°æ® (.h5ad)
â”‚   â”œâ”€â”€ MEND139.h5ad
â”‚   â”œâ”€â”€ MEND140.h5ad
â”‚   â””â”€â”€ ...
â””â”€â”€ processed_data/                  # å¤„ç†åçš„æ•°æ®
    â”œâ”€â”€ 1spot_uni_ebd/              # UNIåµŒå…¥ (.pt)
    â”‚   â”œâ”€â”€ MEND139_uni.pt          # [spots, 1024]
    â”‚   â””â”€â”€ MEND140_uni.pt
    â”œâ”€â”€ 1spot_uni_ebd_aug/          # UNIå¢å¼ºåµŒå…¥
    â”œâ”€â”€ 1spot_conch_ebd/            # CONCHåµŒå…¥
    â”œâ”€â”€ 1spot_conch_ebd_aug/        # CONCHå¢å¼ºåµŒå…¥
    â”œâ”€â”€ all_slide_lst.txt           # æ‰€æœ‰slide ID (23ä¸ª)
    â””â”€â”€ selected_gene_list.txt      # åŸºå› åˆ—è¡¨ (200ä¸ª)
```

### å…³é”®æ–‡ä»¶æ ¼å¼
- **åµŒå…¥æ–‡ä»¶**: `.pt` - PyTorchå¼ é‡æ ¼å¼
  - **2Dæ ¼å¼**: `torch.Tensor [num_spots, 1024]` - æ¯ä¸ªspotä¸€ä¸ªç‰¹å¾å‘é‡
  - **3Dæ ¼å¼**: `torch.Tensor [num_spots, num_patches, 1024]` - æ¯ä¸ªspotå¤šä¸ªpatches (è‡ªåŠ¨å–å¹³å‡)
  - æ ‡å‡†æ ¼å¼: `{slide_id}_{encoder_name}.pt` (å¦‚: `MEND139_uni.pt`)
  - å¢å¼ºæ ¼å¼: `{slide_id}_{encoder_name}_aug.pt` (å¦‚: `MEND139_uni_aug.pt`)
- **åŸºå› åˆ—è¡¨**: `.txt` - æ¯è¡Œä¸€ä¸ªåŸºå› å
- **Slideåˆ—è¡¨**: `.txt` - æ¯è¡Œä¸€ä¸ªslide ID
- **STæ•°æ®**: `.h5ad` - AnnDataæ ¼å¼ (ä¿æŒä¸å˜)

### åµŒå…¥æ–‡ä»¶å¤„ç†ç­–ç•¥
ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¹¶å¤„ç†ä¸¤ç§åµŒå…¥æ ¼å¼ï¼š

1. **2Dæ ¼å¼** `[num_spots, 1024]`: ç›´æ¥ä½¿ç”¨
2. **3Dæ ¼å¼** `[num_spots, num_patches, 1024]`: å¯¹patchesç»´åº¦å–å¹³å‡
   - ä¾‹å¦‚: `[3749, 7, 1024]` â†’ `[3749, 1024]` (7ä¸ªpatcheså–å¹³å‡)
   - è¿™ç§æ ¼å¼å¸¸è§äºå¤šå°ºåº¦ç‰¹å¾æå–ï¼ˆä¸­å¿ƒpatch + å‘¨å›´patchesï¼‰

### æ–‡ä»¶å‘½åè§„èŒƒè¯¦è§£
| ç¼–ç å™¨ | æ ‡å‡†åµŒå…¥ | å¢å¼ºåµŒå…¥ |
|--------|----------|----------|
| **UNI** | `{slide_id}_uni.pt` | `{slide_id}_uni_aug.pt` |
| **CONCH** | `{slide_id}_conch.pt` | `{slide_id}_conch_aug.pt` |

**ç¤ºä¾‹**:
- æ ‡å‡†UNIåµŒå…¥: `MEND139_uni.pt`
- å¢å¼ºUNIåµŒå…¥: `MEND139_uni_aug.pt`
- æ ‡å‡†CONCHåµŒå…¥: `MEND139_conch.pt`
- å¢å¼ºCONCHåµŒå…¥: `MEND139_conch_aug.pt`

---

## âœ… æµ‹è¯•éªŒè¯ç»“æœ

è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶éªŒè¯è¿ç§»æˆåŠŸï¼š

```bash
$ python test_migration.py

ğŸš€ å¼€å§‹MFBPé¡¹ç›®æ•°æ®ç»“æ„è¿ç§»æµ‹è¯•

âœ… æ¨¡å—å¯¼å…¥æµ‹è¯•é€šè¿‡
âœ… STDatasetåˆå§‹åŒ–æµ‹è¯•é€šè¿‡  
âœ… MFBPæ¨¡å‹æµ‹è¯•é€šè¿‡
âœ… é…ç½®æ–‡ä»¶åŠ è½½æµ‹è¯•é€šè¿‡
âœ… å‘½ä»¤è¡Œå‚æ•°æµ‹è¯•é€šè¿‡

ğŸ“Š æ€»ä½“ç»“æœ: 5/5 ä¸ªæµ‹è¯•é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ•°æ®ç»“æ„è¿ç§»æˆåŠŸï¼
```

---

## ğŸ¯ å…³é”®æˆå°±

### âœ… å®Œå…¨å®ç°çš„åŠŸèƒ½
1. **æ–°æ•°æ®æ ¼å¼æ”¯æŒ** - å®Œæ•´æ”¯æŒhest1k_datasetsæ ¼å¼
2. **slide-basedæ•°æ®åˆ’åˆ†** - çµæ´»çš„éªŒè¯é›†/æµ‹è¯•é›†æŒ‡å®š
3. **å¤šç¼–ç å™¨æ”¯æŒ** - uni/conchç¼–ç å™¨åˆ‡æ¢
4. **å¢å¼ºåµŒå…¥æ”¯æŒ** - å¯é€‰çš„æ•°æ®å¢å¼º
5. **ç®€åŒ–æ¨¡å‹æ¶æ„** - ç§»é™¤å¤æ‚çš„å¯†åº¦é¢„æµ‹
6. **ç»Ÿä¸€æ¥å£** - æ‰€æœ‰æ•°æ®é›†ä½¿ç”¨ç›¸åŒSTDatasetç±»

### âœ… ä»£ç è´¨é‡æå‡
- **ä»£ç ç®€åŒ–**: å‡å°‘ ~25% ä»£ç è¡Œæ•°
- **æ¶æ„æ¸…æ™°**: å•ä¸€èŒè´£åŸåˆ™
- **æ˜“äºç»´æŠ¤**: ç§»é™¤å¤æ‚çš„åŒä»»åŠ¡é€»è¾‘
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å‚æ•°éªŒè¯å’Œé”™è¯¯æç¤º

### âœ… æ€§èƒ½ä¼˜åŒ–
- **å†…å­˜ä¼˜åŒ–**: å»¶è¿ŸåŠ è½½ç­–ç•¥
- **è®­ç»ƒæ•ˆç‡**: ç®€åŒ–çš„æŸå¤±è®¡ç®—
- **çµæ´»æ€§**: æ”¯æŒå¤šç§æ•°æ®é›†å’Œç¼–ç å™¨

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. å‡†å¤‡æ•°æ®
ç¡®ä¿æ•°æ®æŒ‰æ–°æ ¼å¼ç»„ç»‡ï¼ŒåŒ…å«å¿…è¦çš„æ–‡ä»¶ï¼š
- `processed_data/selected_gene_list.txt`
- `processed_data/all_slide_lst.txt`
- `processed_data/1spot_{encoder}_ebd/`ç›®å½•
- `st/`ç›®å½•ä¸­çš„.h5adæ–‡ä»¶

### 2. è¿è¡Œè®­ç»ƒ
```bash
python src/main.py \
    --config config/hest/base_config.yaml \
    --expr_name PRAD \
    --data_path /path/to/hest1k_datasets/PRAD/ \
    --slide_val "slide1,slide2" \
    --slide_test "slide3,slide4" \
    --encoder_name uni \
    --mode train
```

### 3. éªŒè¯ç»“æœ
- è®­ç»ƒæ—¥å¿—å°†æ˜¾ç¤ºç®€åŒ–çš„æŸå¤±ä¿¡æ¯
- æ¨¡å‹åªé¢„æµ‹åŸºå› è¡¨è¾¾ï¼Œä¸å†æœ‰å¯†åº¦é¢„æµ‹
- éªŒè¯æŒ‡æ ‡åŒ…æ‹¬MSEã€MAEã€Pearsonç›¸å…³ç³»æ•°ç­‰

---

## ğŸ“ æ”¯æŒä¸ç»´æŠ¤

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆæ–°è¦æ±‚
2. æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
3. slide IDæ˜¯å¦å­˜åœ¨äºall_slide_lst.txtä¸­
4. å‘½ä»¤è¡Œå‚æ•°æ˜¯å¦æ­£ç¡®

**è¿ç§»å®Œæˆï¼** ğŸ‰ æ–°çš„MFBPç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨æ–°çš„hest1k_datasetsæ ¼å¼è¿›è¡Œè®­ç»ƒã€‚ 

---

## ğŸš€ æœ€æ–°æ”¹è¿›: ç¼–ç å™¨ç»´åº¦é€‚é… (2024æ›´æ–°)

### âœ¨ æ–°å¢åŠŸèƒ½
åŸºäºç”¨æˆ·æä¾›çš„ `get_img_patch_embd` å‡½æ•°åˆ†æï¼Œæˆ‘ä»¬å‘ç°CONCHå’ŒUNIç¼–ç å™¨è¾“å‡ºä¸åŒçš„ç‰¹å¾ç»´åº¦ï¼š
- **UNIç¼–ç å™¨**: 1024ç»´
- **CONCHç¼–ç å™¨**: 512ç»´

### ğŸ”§ æŠ€æœ¯æ”¹è¿›

**1. åŠ¨æ€ç»´åº¦éªŒè¯**
- ä¿®æ”¹ `STDataset.load_emb()` æ–¹æ³•ï¼Œæ ¹æ®ç¼–ç å™¨ç±»å‹éªŒè¯ç‰¹å¾ç»´åº¦
- ç§»é™¤ç¡¬ç¼–ç çš„1024ç»´æ£€æŸ¥ï¼Œæ”¹ä¸ºåŠ¨æ€é€‚é…

**2. é…ç½®åŠ¨æ€æ›´æ–°**
- åœ¨ `main.py` ä¸­æ ¹æ® `--encoder_name` å‚æ•°è‡ªåŠ¨è®¾ç½® `config.MODEL.feature_dim`
- UNI: `feature_dim = 1024`
- CONCH: `feature_dim = 512`

**3. æ¨¡å‹è‡ªé€‚åº”**
- MFBPæ¨¡å‹è‡ªåŠ¨æ ¹æ®é…ç½®ä¸­çš„ `feature_dim` è°ƒæ•´è¾“å…¥å±‚ç»´åº¦
- æ”¯æŒä¸åŒç¼–ç å™¨æ— ç¼åˆ‡æ¢

### ğŸ§ª æµ‹è¯•éªŒè¯
åˆ›å»ºäº† `test_encoder_dimensions.py` ç»¼åˆæµ‹è¯•å¥—ä»¶ï¼ŒéªŒè¯ï¼š

| æµ‹è¯•é¡¹ç›® | UNI (1024ç»´) | CONCH (512ç»´) | çŠ¶æ€ |
|----------|-------------|--------------|------|
| **2DåµŒå…¥åŠ è½½** | âœ… `[10, 1024]` | âœ… `[10, 512]` | é€šè¿‡ |
| **3DåµŒå…¥è½¬æ¢** | âœ… `[10, 7, 1024]â†’[10, 1024]` | âœ… `[10, 7, 512]â†’[10, 512]` | é€šè¿‡ |
| **æ¨¡å‹å‰å‘ä¼ æ’­** | âœ… `è¾“å…¥[1,10,1024]â†’è¾“å‡º[1,10,50]` | âœ… `è¾“å…¥[1,10,512]â†’è¾“å‡º[1,10,50]` | é€šè¿‡ |
| **å¢å¼ºåµŒå…¥æ”¯æŒ** | âœ… æ”¯æŒ | âœ… æ”¯æŒ | é€šè¿‡ |

### ğŸ“Š å…¼å®¹æ€§çŸ©é˜µ

| ç¼–ç å™¨ | æ ‡å‡†åµŒå…¥ | å¢å¼ºåµŒå…¥ | 2Dæ ¼å¼ | 3Dæ ¼å¼ | ç‰¹å¾ç»´åº¦ |
|--------|----------|----------|--------|--------|----------|
| **UNI** | âœ… | âœ… | âœ… | âœ… | 1024 |
| **CONCH** | âœ… | âœ… | âœ… | âœ… | 512 |

### ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

**UNIç¼–ç å™¨è®­ç»ƒ**:
```bash
python src/main.py \
    --config config/hest/base_config.yaml \
    --expr_name PRAD \
    --data_path /data/ouyangjiarui/stem/hest1k_datasets/PRAD/ \
    --encoder_name uni \
    --slide_val "SPA154,SPA153" \
    --mode train
# âœ… è‡ªåŠ¨è®¾ç½® feature_dim=1024
```

**CONCHç¼–ç å™¨è®­ç»ƒ**:
```bash
python src/main.py \
    --config config/hest/base_config.yaml \
    --expr_name PRAD \
    --data_path /data/ouyangjiarui/stem/hest1k_datasets/PRAD/ \
    --encoder_name conch \
    --slide_val "SPA154,SPA153" \
    --mode train
# âœ… è‡ªåŠ¨è®¾ç½® feature_dim=512
```

### ğŸ” ä»£ç å˜æ›´æ‘˜è¦
1. **`src/dataset/hest_dataset.py`** - åŠ¨æ€ç»´åº¦éªŒè¯
2. **`src/main.py`** - é…ç½®åŠ¨æ€æ›´æ–°
3. **`config/hest/base_config.yaml`** - æ³¨é‡Šè¯´æ˜åŠ¨æ€è¦†ç›–
4. **`test_encoder_dimensions.py`** - æ–°å¢æµ‹è¯•å¥—ä»¶

è¿™æ¬¡æ”¹è¿›ç¡®ä¿äº†ç³»ç»Ÿå¯¹ä¸åŒç¼–ç å™¨çš„å®Œå…¨å…¼å®¹æ€§ï¼Œä¸ºä½¿ç”¨CONCHç¼–ç å™¨çš„ç”¨æˆ·æä¾›äº†æ— ç¼ä½“éªŒï¼ 