# ğŸš€ MFBPé¡¹ç›®æ•°æ®ç»“æ„è¿ç§»ä¸ä»£ç é‡æ„æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºPyTorch Lightningçš„ç©ºé—´è½¬å½•ç»„å­¦(ST)é¡¹ç›®ï¼Œä½¿ç”¨MFBPæ¨¡å‹è¿›è¡ŒåŸºå› è¡¨è¾¾é¢„æµ‹ã€‚ç°éœ€è¦å°†æ•°æ®ç»“æ„ä»åŸå§‹HESTæ ¼å¼å®Œå…¨è¿ç§»åˆ°æ–°çš„hest1k_datasetsæ ¼å¼ï¼Œå¹¶ç®€åŒ–æ¨¡å‹æ¶æ„ã€‚

**æ ¸å¿ƒå˜æ›´**: ä»åŒä»»åŠ¡å­¦ä¹ (åŸºå› è¡¨è¾¾+å¯†åº¦é¢„æµ‹)ç®€åŒ–ä¸ºå•ä»»åŠ¡å­¦ä¹ (ä»…åŸºå› è¡¨è¾¾é¢„æµ‹)ï¼ŒåŒæ—¶é€‚é…æ–°çš„æ•°æ®ç»„ç»‡ç»“æ„ã€‚

---

## ğŸ”„ æ•°æ®ç»“æ„å˜æ›´å¯¹æ¯”

### åŸå§‹æ•°æ®ç»“æ„ âŒ
```
/data/ouyangjiarui/hest/processhest/
â”œâ”€â”€ adata/                          # STæ•°æ® (.h5ad)
â”‚   â”œâ”€â”€ TENX115.h5ad
â”‚   â””â”€â”€ TENX117.h5ad
â”œâ”€â”€ emb/                           # åµŒå…¥ç‰¹å¾ (.h5)
â”‚   â””â”€â”€ global/uni_v1/
â”‚       â”œâ”€â”€ TENX115.h5
â”‚       â””â”€â”€ TENX117.h5
â”œâ”€â”€ patches/                       # å›¾åƒpatches (.h5)
â”‚   â”œâ”€â”€ TENX115.h5
â”‚   â””â”€â”€ TENX117.h5
â””â”€â”€ splits/                        # æ•°æ®åˆ’åˆ† (.csv, .json)
    â””â”€â”€ SKCM/
        â”œâ”€â”€ train_0.csv            # è®­ç»ƒé›†æ ·æœ¬ID
        â”œâ”€â”€ test_0.csv             # æµ‹è¯•é›†æ ·æœ¬ID
        â”œâ”€â”€ mean_50genes.json      # ç›®æ ‡åŸºå› åˆ—è¡¨
        â”œâ”€â”€ mean_200genes.json     # å¯†åº¦åŸºå› åˆ—è¡¨
        â”œâ”€â”€ normalized_weights.json # å¯†åº¦æƒé‡
        â””â”€â”€ ids.csv                # ç–¾ç—…æ ·æœ¬ID
```

### æ–°æ•°æ®ç»“æ„ âœ…
```
/data/ouyangjiarui/stem/hest1k_datasets/
â”œâ”€â”€ PRAD/                          # æ•°æ®é›†åç§°
â”‚   â”œâ”€â”€ wsis/                      # å…¨åˆ‡ç‰‡å›¾åƒ (WSI)
â”‚   â”‚   â”œâ”€â”€ slide1.svs
â”‚   â”‚   â””â”€â”€ slide2.svs
â”‚   â”œâ”€â”€ st/                        # ST h5adæ•°æ® (æ ¼å¼ä¸å˜)
â”‚   â”‚   â”œâ”€â”€ MEND139.h5ad
â”‚   â”‚   â”œâ”€â”€ MEND140.h5ad
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ processed_data/            # å¤„ç†åçš„æ•°æ®
â”‚       â”œâ”€â”€ 1spot_uni_ebd/         # UNIåµŒå…¥ (.ptæ–‡ä»¶)
â”‚       â”‚   â”œâ”€â”€ MEND139_uni.pt     # [spots, 1024]
â”‚       â”‚   â”œâ”€â”€ MEND140_uni.pt
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ 1spot_uni_ebd_aug/     # UNIå¢å¼ºåµŒå…¥
â”‚       â”œâ”€â”€ 1spot_conch_ebd/       # CONCHåµŒå…¥
â”‚       â”œâ”€â”€ 1spot_conch_ebd_aug/   # CONCHå¢å¼ºåµŒå…¥
â”‚       â”œâ”€â”€ all_slide_lst.txt      # æ‰€æœ‰slide IDåˆ—è¡¨ (23ä¸ª)
â”‚       â””â”€â”€ selected_gene_list.txt # é€‰å®šåŸºå› åˆ—è¡¨ (200ä¸ª)
â”œâ”€â”€ her2st/                        # å…¶ä»–æ•°æ®é›†
â”œâ”€â”€ kidney/
â””â”€â”€ mouse_brain/
```

---

## ğŸ“Š å…³é”®æ–‡ä»¶æ ¼å¼ç¡®è®¤

| æ–‡ä»¶ç±»å‹ | æ ¼å¼ | å†…å®¹æè¿° | ç¤ºä¾‹ | åŠ è½½æ–¹å¼ |
|---------|------|----------|------|----------|
| **åµŒå…¥æ–‡ä»¶** | `.pt` | torch.Tensor, å½¢çŠ¶`[spots, 1024]` | `MEND139_uni.pt` | `torch.load(file, weights_only=True)` |
| **åŸºå› åˆ—è¡¨** | `.txt` | æ¯è¡Œä¸€ä¸ªåŸºå› åï¼Œå…±200ä¸ªåŸºå›  | `A2M\nACTB\nACTG1...` | `open().readlines()` |
| **Slideåˆ—è¡¨** | `.txt` | æ¯è¡Œä¸€ä¸ªslide IDï¼Œå…±23ä¸ªslides | `SPA154\nSPA153\nSPA152...` | `open().readlines()` |
| **STæ•°æ®** | `.h5ad` | AnnDataæ ¼å¼ï¼Œä¿æŒä¸å˜ | åŸæœ‰æ ¼å¼ | `scanpy.read_h5ad()` |

### æ–‡ä»¶å‘½åè§„èŒƒ
- **åµŒå…¥æ–‡ä»¶**: `{slide_id}_{encoder_name}.pt` (å¦‚: `MEND139_uni.pt`, `SPA154_conch.pt`)
- **STæ–‡ä»¶**: `{slide_id}.h5ad` (å¦‚: `MEND139.h5ad`)
- **ç¼–ç å™¨ç±»å‹**: `uni` æˆ– `conch`
- **å¢å¼ºæ ‡è¯†**: ç›®å½•ååŒ…å«`_aug`åç¼€

---

## ğŸ¯ æ–°å‘½ä»¤è¡Œæ¥å£è®¾è®¡

### ç›®æ ‡å‘½ä»¤æ ¼å¼
```bash
python src/main.py \
    --config config/hest/base_config.yaml \
    --expr_name PRAD \
    --data_path /data/ouyangjiarui/stem/hest1k_datasets/PRAD/ \
    --slide_val "SPA154,SPA153" \
    --slide_test "SPA152,SPA151" \
    --encoder_name uni \
    --use_augmented \
    --mode train
```

### å‚æ•°å˜æ›´è¯´æ˜

#### æ–°å¢å‚æ•° â•
- `--expr_name` (str, required): æ•°æ®é›†åç§° (PRAD, her2st, kidney, mouse_brain)
- `--data_path` (str, required): æ•°æ®é›†æ ¹ç›®å½•è·¯å¾„
- `--slide_val` (str, optional): éªŒè¯é›†slide IDï¼Œé€—å·åˆ†éš”ï¼Œé»˜è®¤ä¸ºç©º
- `--slide_test` (str, optional): æµ‹è¯•é›†slide IDï¼Œé€—å·åˆ†éš”ï¼Œé»˜è®¤ä¸ºç©º
- `--encoder_name` (str, default='uni'): ç¼–ç å™¨ç±»å‹ï¼Œchoices=['uni', 'conch']
- `--use_augmented` (flag): æ˜¯å¦ä½¿ç”¨å¢å¼ºåµŒå…¥ï¼Œé»˜è®¤False

#### ç§»é™¤å‚æ•° â–
- `--disease_type`: ç”±`--expr_name`æ›¿ä»£
- `--fold`: ç”±slide-basedåˆ’åˆ†æ›¿ä»£

#### ä¿ç•™å‚æ•° âœ…
- `--config`: é…ç½®æ–‡ä»¶è·¯å¾„
- `--mode`: è¿è¡Œæ¨¡å¼ (train/test)

---

## ğŸ”§ æ ¸å¿ƒä¿®æ”¹ä»»åŠ¡æ¸…å•

### 1. ä¸»ç¨‹åºä¿®æ”¹ (`src/main.py`)

#### ä»»åŠ¡1.1: æ›´æ–°å‚æ•°è§£æå™¨
- [ ] **æ·»åŠ æ–°å‚æ•°**: åœ¨`get_parse()`å‡½æ•°ä¸­æ·»åŠ æ‰€æœ‰æ–°å‚æ•°
- [ ] **ç§»é™¤æ—§å‚æ•°**: åˆ é™¤`--disease_type`å’Œ`--fold`å‚æ•°
- [ ] **å‚æ•°éªŒè¯**: æ·»åŠ è·¯å¾„å­˜åœ¨æ€§æ£€æŸ¥å’Œencoder_nameæœ‰æ•ˆæ€§éªŒè¯
- [ ] **é»˜è®¤å€¼è®¾ç½®**: ä¸ºå¯é€‰å‚æ•°è®¾ç½®åˆç†é»˜è®¤å€¼

#### ä»»åŠ¡1.2: æ›´æ–°é…ç½®ä¼ é€’
- [ ] **é…ç½®å¯¹è±¡æ›´æ–°**: å°†æ–°å‚æ•°æ·»åŠ åˆ°configå¯¹è±¡
- [ ] **ç§»é™¤æ—§é…ç½®**: åˆ é™¤disease_typeå’Œfoldç›¸å…³é…ç½®
- [ ] **è·¯å¾„è§„èŒƒåŒ–**: ç¡®ä¿data_pathä»¥'/'ç»“å°¾
- [ ] **slideåˆ—è¡¨è§£æ**: å¤„ç†é€—å·åˆ†éš”çš„slide IDå­—ç¬¦ä¸²

### 2. æ•°æ®é›†ç±»é‡æ„ (`src/dataset/hest_dataset.py`)

#### ä»»åŠ¡2.1: å®Œå…¨ç§»é™¤BKDDatasetç±»
- [ ] **åˆ é™¤ç±»å®šä¹‰**: ç§»é™¤æ•´ä¸ªBKDDatasetç±» (çº¦300è¡Œä»£ç )
- [ ] **ç§»é™¤densityç›¸å…³**: åˆ é™¤æ‰€æœ‰density_genes, density_adata_dictç­‰
- [ ] **ç§»é™¤æƒé‡åŠ è½½**: åˆ é™¤normalized_weights.jsonç›¸å…³ä»£ç 
- [ ] **æ¸…ç†å¯¼å…¥**: ç§»é™¤BKDDatasetç›¸å…³çš„å¯¼å…¥è¯­å¥

#### ä»»åŠ¡2.2: é‡æ„STDatasetç±»æ„é€ å‡½æ•°
```python
def __init__(self,
             mode: str,                    # 'train', 'val', 'test'
             data_path: str,               # æ•°æ®é›†æ ¹è·¯å¾„
             expr_name: str,               # æ•°æ®é›†åç§°
             slide_val: str = '',          # éªŒè¯é›†slides
             slide_test: str = '',         # æµ‹è¯•é›†slides
             encoder_name: str = 'uni',    # ç¼–ç å™¨ç±»å‹
             use_augmented: bool = False,  # æ˜¯å¦ä½¿ç”¨å¢å¼º
             normalize: bool = True,       # æ•°æ®å½’ä¸€åŒ–
             cpm: bool = True,            # CPMå½’ä¸€åŒ–
             smooth: bool = True):        # é«˜æ–¯å¹³æ»‘
```

#### ä»»åŠ¡2.3: è·¯å¾„æ„å»ºé€»è¾‘é‡å†™
- [ ] **STæ•°æ®è·¯å¾„**: `self.st_dir = f"{data_path}/st"`
- [ ] **å¤„ç†æ•°æ®è·¯å¾„**: `self.processed_dir = f"{data_path}/processed_data"`
- [ ] **åµŒå…¥è·¯å¾„æ„å»º**: æ ¹æ®encoder_nameå’Œuse_augmentedåŠ¨æ€æ„å»º
- [ ] **æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥**: éªŒè¯å…³é”®ç›®å½•å’Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨

#### ä»»åŠ¡2.4: å…³é”®æ–¹æ³•å®ç°

##### `load_gene_list()` æ–¹æ³•
- [ ] **æ–‡ä»¶è¯»å–**: ä»`selected_gene_list.txt`è¯»å–åŸºå› åˆ—è¡¨
- [ ] **æ•°æ®æ¸…ç†**: å»é™¤ç©ºè¡Œå’Œç©ºç™½å­—ç¬¦
- [ ] **é”™è¯¯å¤„ç†**: æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯çš„å¤„ç†
- [ ] **è¿”å›æ ¼å¼**: è¿”å›åŸºå› åç§°åˆ—è¡¨

##### `load_slide_splits()` æ–¹æ³•
- [ ] **è¯»å–æ‰€æœ‰slides**: ä»`all_slide_lst.txt`è·å–å®Œæ•´åˆ—è¡¨
- [ ] **è§£æè¾“å…¥**: å¤„ç†é€—å·åˆ†éš”çš„slide IDå­—ç¬¦ä¸²
- [ ] **å»é‡å’ŒéªŒè¯**: ç¡®ä¿slide IDæœ‰æ•ˆä¸”æ— é‡å¤
- [ ] **è‡ªåŠ¨åˆ’åˆ†**: å‰©ä½™slidesè‡ªåŠ¨åˆ†é…ç»™è®­ç»ƒé›†
- [ ] **è¿”å›å­—å…¸**: `{'train': [...], 'val': [...], 'test': [...]}`

##### `load_emb()` æ–¹æ³•
- [ ] **æ–‡ä»¶è·¯å¾„æ„å»º**: `{emb_dir}/{slide_id}_{encoder_name}.pt`
- [ ] **PyTorchåŠ è½½**: ä½¿ç”¨`torch.load(weights_only=True)`
- [ ] **ç´¢å¼•å¤„ç†**: æ”¯æŒå•ä¸ªspotæˆ–å…¨éƒ¨spotsçš„åŠ è½½
- [ ] **ç»´åº¦æ£€æŸ¥**: ç¡®ä¿è¿”å›æ­£ç¡®çš„tensorç»´åº¦
- [ ] **é”™è¯¯å¤„ç†**: æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯çš„å¤„ç†

#### ä»»åŠ¡2.5: æ•°æ®åŠ è½½é€»è¾‘æ›´æ–°

##### è®­ç»ƒæ¨¡å¼ (`mode='train'`)
- [ ] **é¢„åŠ è½½STæ•°æ®**: ä¸ºæ‰€æœ‰è®­ç»ƒslidesé¢„åŠ è½½adata
- [ ] **è®¡ç®—ç´¯ç§¯é•¿åº¦**: ç”¨äºspot-levelçš„ç´¢å¼•æ˜ å°„
- [ ] **ä½ç½®ä¿¡æ¯æå–**: ä»adata.obsè·å–array_row, array_col
- [ ] **æ•°æ®å¢å¼º**: å¦‚æœå¯ç”¨ï¼Œåº”ç”¨ç›¸åº”çš„transforms

##### éªŒè¯/æµ‹è¯•æ¨¡å¼ (`mode='val'/'test'`)
- [ ] **æŒ‰slideåŠ è½½**: æ¯æ¬¡è¿”å›å®Œæ•´slideçš„æ•°æ®
- [ ] **å»¶è¿ŸåŠ è½½**: é¿å…å†…å­˜å ç”¨è¿‡å¤§
- [ ] **æ‰¹å¤„ç†æ”¯æŒ**: æ”¯æŒbatch_size=1çš„å¤„ç†

#### ä»»åŠ¡2.6: `__getitem__()` æ–¹æ³•é‡å†™

##### è®­ç»ƒæ¨¡å¼è¿”å›æ ¼å¼
```python
{
    'img': features,           # [1, 1024] æˆ– [1024]
    'target_genes': expression, # [num_genes]
    'positions': positions,     # [2] (array_row, array_col)
    'slide_id': slide_id,      # str
    'spot_idx': spot_idx       # int
}
```

##### éªŒè¯/æµ‹è¯•æ¨¡å¼è¿”å›æ ¼å¼
```python
{
    'img': features,           # [num_spots, 1024]
    'target_genes': expression, # [num_spots, num_genes]
    'positions': positions,     # [num_spots, 2]
    'slide_id': slide_id,      # str
    'num_spots': num_spots     # int
}
```

### 3. æ•°æ®æ¥å£æ›´æ–° (`src/dataset/data_interface.py`)

#### ä»»åŠ¡3.1: ç®€åŒ–DataInterfaceç±»
- [ ] **ç§»é™¤BKDDataset**: ç»Ÿä¸€ä½¿ç”¨STDataset
- [ ] **å‚æ•°ä¼ é€’æ›´æ–°**: ä¼ é€’æ–°çš„å‚æ•°åˆ°æ•°æ®é›†ç±»
- [ ] **setupæ–¹æ³•ç®€åŒ–**: ç§»é™¤å¤æ‚çš„æ¡ä»¶åˆ¤æ–­
- [ ] **é”™è¯¯å¤„ç†**: æ·»åŠ æ•°æ®é›†åˆ›å»ºå¤±è´¥çš„å¤„ç†

#### ä»»åŠ¡3.2: å‚æ•°æ˜ å°„
```python
base_params = {
    'data_path': self.config.data_path,
    'expr_name': self.config.expr_name,
    'slide_val': self.config.slide_val,
    'slide_test': self.config.slide_test,
    'encoder_name': self.config.encoder_name,
    'use_augmented': self.config.use_augmented,
    'normalize': self.config.DATA.normalize,
    'cpm': self.config.DATA.cpm,
    'smooth': self.config.DATA.smooth,
}
```

### 4. æ¨¡å‹ä»£ç ç®€åŒ– (`src/model/`)

#### ä»»åŠ¡4.1: ç§»é™¤å¯†åº¦é¢„æµ‹åŠŸèƒ½

##### MFBPæ¨¡å‹ç±» (`src/model/MFBP/MFBP.py`)
- [ ] **åˆ é™¤å¯†åº¦é¢„æµ‹å™¨**: ç§»é™¤DensityPredictorç›¸å…³ä»£ç 
- [ ] **åˆ é™¤å¯†åº¦ç¼–ç å™¨**: ç§»é™¤DensityEncoderç›¸å…³ä»£ç 
- [ ] **ç®€åŒ–forwardæ–¹æ³•**: åªè¿”å›åŸºå› è¡¨è¾¾é¢„æµ‹
- [ ] **ç§»é™¤å¯†åº¦æŸå¤±**: åˆ é™¤density_loss_weightå’Œç›¸å…³è®¡ç®—

##### æ¨¡å‹æ¥å£ (`src/model/model_interface.py`)
- [ ] **ç®€åŒ–training_step**: ç§»é™¤å¯†åº¦ç›¸å…³çš„æŸå¤±è®¡ç®—
- [ ] **ç®€åŒ–validation_step**: åªè®¡ç®—åŸºå› è¡¨è¾¾æŸå¤±
- [ ] **æ›´æ–°æŒ‡æ ‡è®¡ç®—**: ç§»é™¤å¯†åº¦ç›¸å…³æŒ‡æ ‡
- [ ] **ç®€åŒ–_compute_loss**: åªè®¡ç®—MSEå’Œç›¸å…³æŸå¤±

#### ä»»åŠ¡4.2: æ›´æ–°æŸå¤±è®¡ç®—
- [ ] **å•ä¸€æŸå¤±å‡½æ•°**: åªä½¿ç”¨MSEæŸå¤±è®¡ç®—åŸºå› è¡¨è¾¾
- [ ] **ç§»é™¤æƒé‡**: åˆ é™¤density_loss_weightç›¸å…³é€»è¾‘
- [ ] **æ›´æ–°ç›‘æ§æŒ‡æ ‡**: ä»val_mseæ”¹å›val_loss
- [ ] **ç®€åŒ–æ—¥å¿—è®°å½•**: ç§»é™¤å¯†åº¦ç›¸å…³çš„æ—¥å¿—

#### ä»»åŠ¡4.3: æ¨¡å‹è¾“å‡ºæ ¼å¼
```python
# ç®€åŒ–åçš„è¾“å‡ºæ ¼å¼
outputs = {
    'logits': gene_predictions  # [batch_size, num_genes]
}
```

### 5. é…ç½®æ–‡ä»¶æ›´æ–° (`config/`)

#### ä»»åŠ¡5.1: åŸºç¡€é…ç½®æ–‡ä»¶ (`config/hest/base_config.yaml`)
- [ ] **ç§»é™¤å¯†åº¦é…ç½®**: åˆ é™¤æ‰€æœ‰densityç›¸å…³é…ç½®
- [ ] **æ›´æ–°ç›‘æ§æŒ‡æ ‡**: monitorä»val_mseæ”¹ä¸ºval_loss
- [ ] **ç®€åŒ–æ•°æ®é…ç½®**: ç§»é™¤BKDDatasetç›¸å…³é…ç½®
- [ ] **æ›´æ–°æ—¥å¿—è·¯å¾„**: é€‚é…æ–°çš„æ•°æ®é›†ç»“æ„

#### ä»»åŠ¡5.2: æ•°æ®é›†ç‰¹å®šé…ç½®
- [ ] **åˆ›å»ºé€šç”¨é…ç½®**: ä¸å†éœ€è¦ç–¾ç—…ç‰¹å®šçš„é…ç½®æ–‡ä»¶
- [ ] **å‚æ•°åŒ–è®¾è®¡**: é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è€Œéé…ç½®æ–‡ä»¶æŒ‡å®šæ•°æ®é›†
- [ ] **ä¿æŒå‘å‰å…¼å®¹**: ç¡®ä¿ç°æœ‰çš„è®­ç»ƒè„šæœ¬ä»å¯ä½¿ç”¨

### 6. å¯¼å…¥å’Œåˆå§‹åŒ–æ›´æ–°

#### ä»»åŠ¡6.1: æ•°æ®é›†å¯¼å…¥ (`src/dataset/__init__.py`)
- [ ] **ç§»é™¤BKDDataset**: ä»__all__ä¸­åˆ é™¤
- [ ] **ä¿ç•™STDataset**: ç¡®ä¿æ­£ç¡®å¯¼å…¥
- [ ] **æ¸…ç†æœªä½¿ç”¨å¯¼å…¥**: ç§»é™¤ç›¸å…³çš„å¯¼å…¥è¯­å¥

#### ä»»åŠ¡6.2: æ¨¡å‹å¯¼å…¥æ£€æŸ¥
- [ ] **éªŒè¯æ¨¡å‹å¯¼å…¥**: ç¡®ä¿MFBPæ¨¡å‹æ­£ç¡®å¯¼å…¥
- [ ] **æ¸…ç†æœªä½¿ç”¨æ¨¡å—**: ç§»é™¤å¯†åº¦ç›¸å…³çš„æ¨¡å—å¯¼å…¥

---

## ğŸ¯ å®ç°ä¼˜å…ˆçº§ä¸è¯¦ç»†æ­¥éª¤

### ğŸ”¥ ä¼˜å…ˆçº§1 (æ ¸å¿ƒåŠŸèƒ½) - å¿…é¡»å®Œæˆ

#### æ­¥éª¤1: è·¯å¾„ç³»ç»Ÿé‡æ„ (é¢„è®¡2å°æ—¶)
1. **æ›´æ–°STDatasetæ„é€ å‡½æ•°**
   - ä¿®æ”¹å‚æ•°åˆ—è¡¨
   - é‡å†™è·¯å¾„æ„å»ºé€»è¾‘
   - æ·»åŠ åŸºæœ¬çš„é”™è¯¯æ£€æŸ¥

2. **å®ç°åŸºç¡€æ–‡ä»¶åŠ è½½**
   - `load_gene_list()`æ–¹æ³•
   - `load_slide_splits()`æ–¹æ³•
   - åŸºæœ¬çš„æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥

#### æ­¥éª¤2: åµŒå…¥æ–‡ä»¶åŠ è½½é‡æ„ (é¢„è®¡1.5å°æ—¶)
1. **æ›´æ–°load_embæ–¹æ³•**
   - ä»HDF5æ”¹ä¸ºPyTorchæ ¼å¼
   - å¤„ç†æ–‡ä»¶è·¯å¾„æ„å»º
   - æ·»åŠ é”™è¯¯å¤„ç†

2. **æµ‹è¯•åµŒå…¥åŠ è½½**
   - éªŒè¯tensorå½¢çŠ¶
   - æµ‹è¯•ç´¢å¼•åŠŸèƒ½
   - ç¡®è®¤æ•°æ®ç±»å‹

#### æ­¥éª¤3: æ•°æ®åˆ’åˆ†é€»è¾‘ (é¢„è®¡1å°æ—¶)
1. **å®ç°slideåˆ’åˆ†**
   - è§£æå‘½ä»¤è¡Œå‚æ•°
   - éªŒè¯slide IDæœ‰æ•ˆæ€§
   - è‡ªåŠ¨åˆ†é…è®­ç»ƒé›†

2. **æ›´æ–°æ•°æ®é›†åˆ›å»º**
   - ä¿®æ”¹__getitem__æ–¹æ³•
   - å¤„ç†ä¸åŒæ¨¡å¼çš„æ•°æ®è¿”å›
   - æµ‹è¯•æ•°æ®åŠ è½½

#### æ­¥éª¤4: å‘½ä»¤è¡Œæ¥å£ (é¢„è®¡0.5å°æ—¶)
1. **æ›´æ–°main.py**
   - æ·»åŠ æ–°å‚æ•°
   - ç§»é™¤æ—§å‚æ•°
   - æ›´æ–°é…ç½®ä¼ é€’

### âš¡ ä¼˜å…ˆçº§2 (åŠŸèƒ½ç®€åŒ–) - é‡è¦

#### æ­¥éª¤5: ç§»é™¤å¯†åº¦é¢„æµ‹ (é¢„è®¡2å°æ—¶)
1. **åˆ é™¤BKDDatasetç±»**
   - å®Œå…¨ç§»é™¤ç±»å®šä¹‰
   - æ¸…ç†ç›¸å…³å¯¼å…¥
   - æ›´æ–°__init__.py

2. **ç®€åŒ–æ¨¡å‹ä»£ç **
   - ç§»é™¤å¯†åº¦é¢„æµ‹å™¨
   - ç®€åŒ–forwardæ–¹æ³•
   - æ›´æ–°æŸå¤±è®¡ç®—

#### æ­¥éª¤6: é…ç½®æ–‡ä»¶æ›´æ–° (é¢„è®¡0.5å°æ—¶)
1. **ç®€åŒ–é…ç½®ç»“æ„**
   - ç§»é™¤å¯†åº¦ç›¸å…³é…ç½®
   - æ›´æ–°ç›‘æ§æŒ‡æ ‡
   - æ¸…ç†æœªä½¿ç”¨é…ç½®

### ğŸ”§ ä¼˜å…ˆçº§3 (å®Œå–„åŠŸèƒ½) - å¯é€‰

#### æ­¥éª¤7: é”™è¯¯å¤„ç†å’ŒéªŒè¯ (é¢„è®¡1å°æ—¶)
1. **æ·»åŠ å…¨é¢çš„é”™è¯¯å¤„ç†**
   - æ–‡ä»¶ä¸å­˜åœ¨å¤„ç†
   - æ•°æ®æ ¼å¼éªŒè¯
   - å‚æ•°æœ‰æ•ˆæ€§æ£€æŸ¥

2. **æ·»åŠ æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯**
   - æ•°æ®åŠ è½½è¿›åº¦
   - é”™è¯¯è¯¦ç»†ä¿¡æ¯
   - æ€§èƒ½ç›‘æ§

---

## âœ… è¯¦ç»†éªŒè¯æ£€æŸ¥æ¸…å•

### æ•°æ®åŠ è½½éªŒè¯
- [ ] **åŸºå› åˆ—è¡¨åŠ è½½**
  - [ ] èƒ½æ­£ç¡®è¯»å–selected_gene_list.txt
  - [ ] åŸºå› æ•°é‡æ­£ç¡® (200ä¸ª)
  - [ ] åŸºå› åç§°æ ¼å¼æ­£ç¡®
  - [ ] å¤„ç†ç©ºè¡Œå’Œç‰¹æ®Šå­—ç¬¦

- [ ] **Slideåˆ—è¡¨åŠ è½½**
  - [ ] èƒ½æ­£ç¡®è¯»å–all_slide_lst.txt
  - [ ] Slideæ•°é‡æ­£ç¡® (23ä¸ª)
  - [ ] Slide IDæ ¼å¼éªŒè¯
  - [ ] é‡å¤IDæ£€æµ‹

- [ ] **åµŒå…¥æ–‡ä»¶åŠ è½½**
  - [ ] èƒ½æ­£ç¡®åŠ è½½.ptæ–‡ä»¶
  - [ ] Tensorå½¢çŠ¶æ­£ç¡® [spots, 1024]
  - [ ] æ•°æ®ç±»å‹æ­£ç¡® (float32)
  - [ ] ç´¢å¼•åŠŸèƒ½æ­£å¸¸

- [ ] **STæ•°æ®åŠ è½½**
  - [ ] h5adæ–‡ä»¶æ­£å¸¸è¯»å–
  - [ ] åŸºå› è¿‡æ»¤æ­£ç¡®
  - [ ] ä½ç½®ä¿¡æ¯æå–æ­£ç¡®
  - [ ] æ•°æ®å½’ä¸€åŒ–æ­£å¸¸

### åŠŸèƒ½éªŒè¯
- [ ] **Slideåˆ’åˆ†é€»è¾‘**
  - [ ] éªŒè¯é›†åˆ’åˆ†æ­£ç¡®
  - [ ] æµ‹è¯•é›†åˆ’åˆ†æ­£ç¡®
  - [ ] è®­ç»ƒé›†è‡ªåŠ¨åˆ†é…
  - [ ] æ— é‡å¤å’Œé—æ¼

- [ ] **æ•°æ®é›†åˆ›å»º**
  - [ ] è®­ç»ƒæ•°æ®é›†åˆ›å»ºæˆåŠŸ
  - [ ] éªŒè¯æ•°æ®é›†åˆ›å»ºæˆåŠŸ
  - [ ] æµ‹è¯•æ•°æ®é›†åˆ›å»ºæˆåŠŸ
  - [ ] æ•°æ®åŠ è½½å™¨æ­£å¸¸å·¥ä½œ

- [ ] **æ¨¡å‹æ¥å£**
  - [ ] å‰å‘ä¼ æ’­æ­£å¸¸
  - [ ] è¾“å‡ºæ ¼å¼æ­£ç¡®
  - [ ] æ¢¯åº¦è®¡ç®—æ­£å¸¸
  - [ ] å†…å­˜ä½¿ç”¨åˆç†

### è®­ç»ƒéªŒè¯
- [ ] **è®­ç»ƒå¯åŠ¨**
  - [ ] å‘½ä»¤è¡Œå‚æ•°è§£ææ­£ç¡®
  - [ ] é…ç½®åŠ è½½æˆåŠŸ
  - [ ] æ•°æ®æ¨¡å—åˆå§‹åŒ–
  - [ ] æ¨¡å‹åˆå§‹åŒ–æˆåŠŸ

- [ ] **è®­ç»ƒè¿‡ç¨‹**
  - [ ] æŸå¤±æ­£å¸¸ä¸‹é™
  - [ ] éªŒè¯æŒ‡æ ‡è®¡ç®—
  - [ ] å­¦ä¹ ç‡è°ƒåº¦æ­£å¸¸
  - [ ] æ—©åœæœºåˆ¶å·¥ä½œ

- [ ] **æ¨¡å‹ä¿å­˜**
  - [ ] æ£€æŸ¥ç‚¹æ­£å¸¸ä¿å­˜
  - [ ] æœ€ä½³æ¨¡å‹è®°å½•
  - [ ] æ—¥å¿—æ–‡ä»¶ç”Ÿæˆ
  - [ ] æŒ‡æ ‡è®°å½•å®Œæ•´

### æ€§èƒ½éªŒè¯
- [ ] **å†…å­˜ä½¿ç”¨**
  - [ ] è®­ç»ƒæ—¶å†…å­˜ç¨³å®š
  - [ ] æ— å†…å­˜æ³„æ¼
  - [ ] å¤§æ•°æ®é›†æ”¯æŒ
  - [ ] GPUå†…å­˜ä¼˜åŒ–

- [ ] **é€Ÿåº¦æ€§èƒ½**
  - [ ] æ•°æ®åŠ è½½é€Ÿåº¦
  - [ ] è®­ç»ƒé€Ÿåº¦åˆç†
  - [ ] éªŒè¯é€Ÿåº¦æ­£å¸¸
  - [ ] æ•´ä½“æ•ˆç‡æå‡

---

## ğŸš¨ é‡è¦æ³¨æ„äº‹é¡¹ä¸è¾¹ç•Œæƒ…å†µ

### âš ï¸ å®Œå…¨è¿ç§»åŸåˆ™
- **é›¶å‘åå…¼å®¹**: å®Œå…¨åˆ é™¤æ—§æ ¼å¼æ”¯æŒï¼Œä¸ä¿ç•™ä»»ä½•å…¼å®¹ä»£ç 
- **å½»åº•æ¸…ç†**: ç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ä»£ç ã€é…ç½®å’Œå¯¼å…¥
- **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰æ•°æ®é›†ä½¿ç”¨ç›¸åŒçš„STDatasetç±»å’Œæ¥å£

### ğŸ” å…³é”®å˜æ›´ç‚¹è¯¦è§£

#### 1. æ–‡ä»¶æ ¼å¼å˜æ›´
- **åµŒå…¥æ–‡ä»¶**: `.h5` (HDF5) â†’ `.pt` (PyTorch)
- **åŸºå› åˆ—è¡¨**: `.json` â†’ `.txt`
- **æ•°æ®åˆ’åˆ†**: `.csv` â†’ å‘½ä»¤è¡Œå‚æ•°
- **æƒé‡æ–‡ä»¶**: å®Œå…¨ç§»é™¤

#### 2. è·¯å¾„ç»“æ„å˜æ›´
- **å¤šçº§ç›®å½•**: `emb/global/uni_v1/` â†’ `processed_data/1spot_uni_ebd/`
- **æ‰å¹³åŒ–è®¾è®¡**: å‡å°‘ç›®å½•å±‚çº§ï¼Œç®€åŒ–è·¯å¾„æ„å»º
- **ç»Ÿä¸€å‘½å**: æ‰€æœ‰æ–‡ä»¶éµå¾ªç»Ÿä¸€çš„å‘½åè§„èŒƒ

#### 3. å‚æ•°ç³»ç»Ÿå˜æ›´
- **Fold-based**: `--fold 0` â†’ **Slide-based**: `--slide_val "id1,id2"`
- **ç–¾ç—…ç±»å‹**: `--disease_type SKCM` â†’ **æ•°æ®é›†åç§°**: `--expr_name PRAD`
- **è·¯å¾„æŒ‡å®š**: ä»é…ç½®æ–‡ä»¶ â†’ å‘½ä»¤è¡Œå‚æ•°

#### 4. æ¨¡å‹åŠŸèƒ½å˜æ›´
- **åŒä»»åŠ¡**: åŸºå› è¡¨è¾¾ + å¯†åº¦é¢„æµ‹ â†’ **å•ä»»åŠ¡**: ä»…åŸºå› è¡¨è¾¾é¢„æµ‹
- **å¤æ‚æŸå¤±**: MSE + Density Loss â†’ **ç®€å•æŸå¤±**: ä»…MSE
- **å¤šè¾“å‡º**: logits + density_pred â†’ **å•è¾“å‡º**: ä»…logits

### ğŸ“ ä»£ç è´¨é‡è¦æ±‚

#### é”™è¯¯å¤„ç†è¦æ±‚
- **æ–‡ä»¶æ£€æŸ¥**: æ‰€æœ‰æ–‡ä»¶æ“ä½œå‰æ£€æŸ¥å­˜åœ¨æ€§
- **æ ¼å¼éªŒè¯**: éªŒè¯æ•°æ®æ ¼å¼å’Œå†…å®¹æ­£ç¡®æ€§
- **å¼‚å¸¸æ•è·**: ä½¿ç”¨try-exceptå¤„ç†æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸
- **é”™è¯¯ä¿¡æ¯**: æä¾›æ¸…æ™°ã€æœ‰ç”¨çš„é”™è¯¯ä¿¡æ¯

#### ä»£ç è§„èŒƒè¦æ±‚
- **æ³¨é‡Šå®Œæ•´**: æ‰€æœ‰æ–°æ–¹æ³•å’Œå¤æ‚é€»è¾‘æ·»åŠ æ³¨é‡Š
- **å˜é‡å‘½å**: ä½¿ç”¨æè¿°æ€§çš„å˜é‡å
- **ç±»å‹æç¤º**: ä¸ºå‡½æ•°å‚æ•°å’Œè¿”å›å€¼æ·»åŠ ç±»å‹æç¤º
- **ä»£ç æ•´æ´**: ç§»é™¤æ‰€æœ‰è°ƒè¯•æ‰“å°å’Œä¸´æ—¶ä»£ç 

#### æ€§èƒ½è¦æ±‚
- **å†…å­˜ä¼˜åŒ–**: é¿å…ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶å’Œç¼“å­˜
- **å»¶è¿ŸåŠ è½½**: å¤§æ–‡ä»¶ä½¿ç”¨å»¶è¿ŸåŠ è½½ç­–ç•¥
- **æ‰¹å¤„ç†**: æ”¯æŒé«˜æ•ˆçš„æ‰¹å¤„ç†æ“ä½œ
- **GPUåˆ©ç”¨**: ç¡®ä¿GPUå†…å­˜ä½¿ç”¨åˆç†

### ğŸ”§ è¾¹ç•Œæƒ…å†µå¤„ç†

#### æ•°æ®è¾¹ç•Œæƒ…å†µ
- **ç©ºslideåˆ—è¡¨**: éªŒè¯æˆ–æµ‹è¯•é›†ä¸ºç©ºçš„å¤„ç†
- **é‡å¤slide ID**: æ£€æµ‹å’Œå¤„ç†é‡å¤çš„slide ID
- **ç¼ºå¤±æ–‡ä»¶**: æŸäº›slideç¼ºå°‘åµŒå…¥æˆ–STæ–‡ä»¶
- **æ ¼å¼é”™è¯¯**: æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–æŸå

#### å‚æ•°è¾¹ç•Œæƒ…å†µ
- **æ— æ•ˆè·¯å¾„**: æ•°æ®è·¯å¾„ä¸å­˜åœ¨æˆ–æ— æƒé™
- **é”™è¯¯ç¼–ç å™¨**: æŒ‡å®šä¸æ”¯æŒçš„ç¼–ç å™¨ç±»å‹
- **slideä¸å­˜åœ¨**: æŒ‡å®šçš„slide IDåœ¨æ•°æ®é›†ä¸­ä¸å­˜åœ¨
- **é…ç½®å†²çª**: å‘½ä»¤è¡Œå‚æ•°ä¸é…ç½®æ–‡ä»¶å†²çª

#### è¿è¡Œæ—¶è¾¹ç•Œæƒ…å†µ
- **å†…å­˜ä¸è¶³**: å¤§æ•°æ®é›†å¯¼è‡´å†…å­˜æº¢å‡º
- **GPUå†…å­˜**: GPUå†…å­˜ä¸è¶³çš„å¤„ç†
- **ç½‘ç»œä¸­æ–­**: åˆ†å¸ƒå¼è®­ç»ƒæ—¶çš„ç½‘ç»œé—®é¢˜
- **ç£ç›˜ç©ºé—´**: æ—¥å¿—å’Œæ£€æŸ¥ç‚¹æ–‡ä»¶çš„ç£ç›˜ç©ºé—´

---

## ğŸ¯ é¢„æœŸæœ€ç»ˆæ•ˆæœä¸æµ‹è¯•æ–¹æ¡ˆ

### æœ€ç»ˆæ•ˆæœç›®æ ‡

#### 1. åŠŸèƒ½å®Œæ•´æ€§
- **æ•°æ®åŠ è½½**: èƒ½å¤Ÿæ­£ç¡®åŠ è½½æ‰€æœ‰æ–°æ ¼å¼çš„æ•°æ®æ–‡ä»¶
- **æ¨¡å‹è®­ç»ƒ**: è®­ç»ƒè¿‡ç¨‹ç¨³å®šï¼Œæ”¶æ•›æ­£å¸¸
- **å¤šæ•°æ®é›†**: æ”¯æŒPRADã€her2stã€kidneyã€mouse_brainç­‰æ•°æ®é›†
- **çµæ´»é…ç½®**: é€šè¿‡å‘½ä»¤è¡Œå‚æ•°çµæ´»é…ç½®è®­ç»ƒå‚æ•°

#### 2. æ€§èƒ½æŒ‡æ ‡
- **è®­ç»ƒé€Ÿåº¦**: ç›¸æ¯”åŸç‰ˆæœ¬ï¼Œè®­ç»ƒé€Ÿåº¦æå‡20%ä»¥ä¸Š
- **å†…å­˜ä½¿ç”¨**: å†…å­˜ä½¿ç”¨å‡å°‘30%ä»¥ä¸Š (ç§»é™¤å¯†åº¦é¢„æµ‹)
- **ä»£ç ç®€æ´**: ä»£ç è¡Œæ•°å‡å°‘25%ä»¥ä¸Š
- **ç»´æŠ¤æ€§**: ä»£ç ç»“æ„æ›´æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

#### 3. ç”¨æˆ·ä½“éªŒ
- **å‘½ä»¤ç®€æ´**: ä¸€è¡Œå‘½ä»¤å³å¯å¯åŠ¨è®­ç»ƒ
- **é”™è¯¯å‹å¥½**: æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®
- **æ—¥å¿—å®Œæ•´**: è¯¦ç»†çš„è®­ç»ƒæ—¥å¿—å’Œè¿›åº¦ä¿¡æ¯
- **æ–‡æ¡£å®Œå–„**: å®Œæ•´çš„ä½¿ç”¨æ–‡æ¡£å’Œç¤ºä¾‹

### è¯¦ç»†æµ‹è¯•æ–¹æ¡ˆ

#### æµ‹è¯•é˜¶æ®µ1: å•å…ƒæµ‹è¯•
```bash
# æµ‹è¯•æ•°æ®åŠ è½½
python -c "
from src.dataset.hest_dataset import STDataset
dataset = STDataset(
    mode='train',
    data_path='/data/ouyangjiarui/stem/hest1k_datasets/PRAD/',
    expr_name='PRAD',
    slide_val='SPA154,SPA153',
    slide_test='SPA152,SPA151',
    encoder_name='uni'
)
print(f'Dataset length: {len(dataset)}')
sample = dataset[0]
print(f'Sample keys: {sample.keys()}')
print(f'Feature shape: {sample[\"img\"].shape}')
print(f'Gene shape: {sample[\"target_genes\"].shape}')
"
```

#### æµ‹è¯•é˜¶æ®µ2: é›†æˆæµ‹è¯•
```bash
# æµ‹è¯•å®Œæ•´è®­ç»ƒæµç¨‹
python src/main.py \
    --config config/hest/base_config.yaml \
    --expr_name PRAD \
    --data_path /data/ouyangjiarui/stem/hest1k_datasets/PRAD/ \
    --slide_val "SPA154,SPA153" \
    --slide_test "SPA152,SPA151" \
    --encoder_name uni \
    --mode train \
    --max_epochs 2  # å¿«é€Ÿæµ‹è¯•
```

#### æµ‹è¯•é˜¶æ®µ3: å¤šæ•°æ®é›†æµ‹è¯•
```bash
# æµ‹è¯•ä¸åŒæ•°æ®é›†
for dataset in PRAD her2st kidney mouse_brain; do
    echo "Testing dataset: $dataset"
    python src/main.py \
        --config config/hest/base_config.yaml \
        --expr_name $dataset \
        --data_path /data/ouyangjiarui/stem/hest1k_datasets/$dataset/ \
        --encoder_name uni \
        --mode train \
        --max_epochs 1
done
```

#### æµ‹è¯•é˜¶æ®µ4: æ€§èƒ½æµ‹è¯•
```bash
# å†…å­˜å’Œé€Ÿåº¦æµ‹è¯•
python -m memory_profiler src/main.py \
    --config config/hest/base_config.yaml \
    --expr_name PRAD \
    --data_path /data/ouyangjiarui/stem/hest1k_datasets/PRAD/ \
    --encoder_name uni \
    --mode train \
    --max_epochs 5
```
